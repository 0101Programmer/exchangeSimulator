{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-sm navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Exchange Simulator</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mynavbar">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="mynavbar">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link active" href="#">Биржа</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
{% endblock %}

{% block header %}{{ header }}{% endblock %}

{% block content %}
<table id="orders_table">
  <thead>
  <tr>
    <th>ID</th>
    <th>Creation time</th>
    <th>Change time</th>
    <th>Status</th>
    <th>Side</th>
    <th>Price</th>
    <th>Amount</th>
    <th>Instrument</th>
  </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<br>

<form id="order-widget">
  <p>
    <label for="instrument-select"></label>
    <select name="instruments" id="instrument-select">
      <!-- Опции будут добавлены через JavaScript -->
    </select>
  </p>
  <p>
    <label for="amount"></label>
    <input name="order-amount" id="amount" type="number" min="1">
  </p>
  <p>
    <label></label>
    <span id="sell-price"></span> <span id="buy-price"></span>
  </p>
  <p>
    <label></label>
    <button id="sell-button">Sell</button> <button id="buy-button">Buy</button>
  </p>
</form>

<script>
  const ws = new WebSocket("ws://localhost:8000/ws");
  let tableData = [];  // Сохраняем данные таблицы для дальнейшего использования

  ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    tableData = data;  // Сохраняем данные в переменную
    const tbody = document.getElementById('tableBody');
    const select = document.getElementById('instrument-select');
    const amount = document.getElementById('amount');
    const sell_price = document.getElementById('sell-price');
    const buy_price = document.getElementById('buy-price');

    // Очищаем изменяемые элементы
    tbody.innerHTML = '';
    select.innerHTML = '';
    amount.value = 1;
    sell_price.innerHTML = '';
    buy_price.innerHTML = '';

    // Заполняем таблицу
    data.forEach((row, index)=> {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.id}</td>
        <td>${new Date(row.creation_time).toLocaleString()}</td>
        <td>${new Date(row.change_time).toLocaleString()}</td>
        <td>${row.status}</td>
        <td>${row.side}</td>
        <td>${row.price}</td>
        <td>${row.amount}</td>
        <td>${row.instrument}</td>
      `;
      tbody.appendChild(tr);

      // Добавляем инструмент в выпадающий список
      const option = document.createElement('option');
      option.value = row.id;
      option.textContent = row.instrument;

      // Устанавливаем первый элемент как выбранный
      if (index === 0) {
        option.selected = true;
        // Обновляем цены для первого инструмента
        updatePrices(row.id);
      }

      select.appendChild(option);
    });

    // Добавляем обработчик события change для select
    select.addEventListener('change', function() {
      // this ссылается на элемент <select>
      const selectedId = parseInt(this.value);  // Получаем выбранный id
      updatePrices(selectedId);  // Обновляем цены
    });
  };
  // Функция для обновления цен
  function updatePrices(selectedId) {
    const sell_price = document.getElementById('sell-price');
    const buy_price = document.getElementById('buy-price');

    // Находим строку данных по selectedId, чтобы получить название инструмента
    const selectedRow = tableData.find(row => row.id === selectedId);
    if (!selectedRow) {
      // проверка было ли найдено значение по id
      sell_price.textContent = 'N/A';
      buy_price.textContent = 'N/A';
      return; // Прерываем выполнение функции, если строка не найдена
    }
    const instrumentName = selectedRow.instrument;  // Получаем название инструмента

    // находим цены для выбранного инструмента
    const sellRow = tableData.find(row => row.instrument === instrumentName && row.side === 'Sell');
    const buyRow = tableData.find(row => row.instrument === instrumentName && row.side === 'Buy');

    // Обновляем элементы <span> с проверкой на существование значения sellRow и buyRow
    sell_price.textContent = sellRow ? `${sellRow.price}` : 'N/A';
    buy_price.textContent = buyRow ? `${buyRow.price}` : 'N/A';
}
</script>

{% endblock %}